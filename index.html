<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>四分化训练Pro Max</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f5f5f7">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f7;
            color: #333;
            margin: 0;
            padding: 20px;
            padding-top: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
        }
        h1 { font-size: 1.6rem; margin-bottom: 5px; color: #1c1c1e; }
        h2 { font-size: 1rem; color: #8e8e93; font-weight: normal; margin-bottom: 15px; }
        
        .card {
            background: white;
            width: 100%;
            max-width: 450px;
            border-radius: 18px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.04);
            padding: 10px 20px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        /* 计时器卡片样式 */
        .timer-card {
            background: #fff;
            width: 100%;
            max-width: 450px;
            border-radius: 18px;
            box-shadow: 0 4px 15px rgba(0,122,255,0.1);
            padding: 15px 20px;
            box-sizing: border-box;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid rgba(0,122,255,0.1);
        }
        .timer-stats {
            font-size: 0.9rem;
            color: #8e8e93;
            margin-bottom: 10px;
            width: 100%;
            text-align: center;
        }
        .timer-display {
            font-size: 2.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums; 
            color: #1c1c1e;
            margin-bottom: 15px;
        }
        .timer-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-start { background-color: #34c759; color: white; }
        .btn-stop { background-color: #ff3b30; color: white; }
        
        /* 列表样式 */
        .workout-item {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .workout-item:last-child { border-bottom: none; }

        .item-header {
            display: flex;
            width: 100%;
            align-items: flex-start;
            cursor: pointer;
        }

        .checkbox {
            min-width: 24px;
            height: 24px;
            border: 2px solid #007aff;
            border-radius: 50%;
            margin-right: 16px;
            margin-top: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .text-content { display: flex; flex-direction: column; flex: 1; }
        .action-name { font-size: 1rem; font-weight: 500; margin-bottom: 4px; }
        .action-note { font-size: 0.85rem; color: #8e8e93; line-height: 1.4; }

        .workout-item.completed .checkbox { background-color: #007aff; color: white; }
        .workout-item.completed .action-name { text-decoration: line-through; color: #c7c7cc; }
        
        .weight-input-area {
            width: 100%;
            margin-top: 10px;
            padding-left: 44px;
            display: flex;
            align-items: center;
        }
        
        .weight-input {
            background: #f2f2f7;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            width: 80px;
            font-size: 0.9rem;
            color: #333;
            text-align: center;
            outline: none;
        }
        .weight-label { font-size: 0.85rem; color: #8e8e93; margin-left: 8px; }

        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 20px;
            cursor: pointer;
        }
        .btn-outline { background: transparent; color: #007aff; border: 1px solid #007aff; }
        .btn-danger { background: transparent; color: #ff3b30; border: 1px solid #ff3b30; font-size: 0.8rem; padding: 8px 15px; margin-left: auto; }

        #edit-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; padding: 20px; box-sizing: border-box;
            flex-direction: column;
        }
        #json-editor {
            flex: 1; width: 100%; border: 1px solid #ccc; border-radius: 10px;
            padding: 10px; font-family: monospace; font-size: 14px; margin-bottom: 10px; background: #f9f9f9;
        }
        .editor-hint { font-size: 0.85rem; color: #666; margin-bottom: 10px; background: #eee; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <h1 id="day-title">加载中...</h1>
    <h2 id="date-display">...</h2>

    <div class="timer-card">
        <div class="timer-stats" id="avg-time-display">加载历史数据...</div>
        <div class="timer-display" id="timer-clock">00:00:00</div>
        <button class="timer-btn btn-start" id="timer-action-btn" onclick="toggleTimer()">开始计时</button>
    </div>

    <div class="card" id="list-container"></div>

    <div class="status-bar" id="progress-text">今日进度: 0%</div>

    <button class="btn btn-outline" onclick="openEditor()">⚙️ 修改/重置 训练计划</button>

    <div id="edit-modal">
        <h3>编辑计划 (JSON模式)</h3>
        <div class="editor-hint">JSON 编辑模式：请保持格式正确。</div>
        <textarea id="json-editor"></textarea>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn" onclick="savePlan()">保存并生效</button>
            <button class="btn btn-outline" onclick="closeEditor()">取消</button>
            <button class="btn btn-danger" onclick="resetToDefault()">重置为默认四分化</button>
        </div>
    </div>

    <script>
    // === 核心数据 ===
    const defaultPlan = {
        1: [
            `平板卧推 | 75% 4组x6次 <br> <span class='note'>全程锁死肩胛骨，关注离心下放，不需要顶峰挤压</span>`,
            `坐姿哑铃推肩 | 3组x8-12次 <br> <span class='note'>以左手(弱侧)次数为准，随手臂自然活动</span>`,
            `双杠臂屈伸(胸肌版) | 3组x力竭 <br> <span class='note'>身体大幅前倾，含胸，肘部微张</span>`,
            `器械夹胸 | 4组x12次 <br> <span class='note'>顶峰停顿1秒，感受挤压感</span>`,
            `哑铃侧平举 | 5-6组x15-20次 <br> <span class='note'>侧肩是宽度的关键</span>`
        ],
        2: [ `休息日 (有氧恢复) <br> <span class='note'>促进血液循环，帮助恢复 (25-40分钟)</span>` ],
        3: [
            `硬拉 | 80% 1组x6次 <br> <span class='note'>力量基石，高质量大重量</span>`,
            `高位下拉 | 4组x12次`,
            `坐姿器械划船 | 4组x12次`,
            `直臂下压 | 4组x15-20次`,
            `绳索面拉 | 4组x15-20次 <br> <span class='note'>手肘比肩高，拉向额头</span>`,
            `悬垂举腿/反向卷腹 | 3组x力竭 <br> <span class='note'>针对下腹部</span>`
        ],
        4: [ `休息日 <br> <span class='note'>多吃蛋白质，好好睡觉</span>` ],
        5: [
            `EZ杆碎颅者 | 3组x12次`,
            `EZ杆弯举 | 3组x12次`,
            `颈后臂屈伸 | 3组x12次`,
            `牧师凳弯举 | 3组x12次`,
            `绳索下压 | 3组x12次`,
            `上斜哑铃弯举 | 3组x12次`,
            `绳索伐木 | 3组x15-20次`,
            `有氧训练 | 20-30分钟 <br> <span class='note'>中等强度恒速(LISS)</span>`
        ],
        6: [ `休息日 <br> <span class='note'>准备明天的练腿日</span>` ],
        0: [
            `深蹲 | 80% 3组x6次 <br> <span class='note'>绝对力量训练</span>`,
            `哑铃原地后撤步蹲 | 3组x10-12次 <br> <span class='note'>向后撤步，对膝盖更友好</span>`,
            `哑铃罗马尼亚硬拉 | 4组x10-12次 <br> <span class='note'>微屈膝锁死，屁股后撅</span>`,
            `腿屈伸 | 4组x15-20次`,
            `腿弯举 | 4组x12-20次`,
            `坐姿外展 | 2组x15-20次 <br> <span class='note'>身体前倾，孤立臀中肌</span>`
        ]
    };

    let weeklyPlan = defaultPlan;
    const storedPlan = localStorage.getItem('my_custom_plan');
    if (storedPlan) { try { weeklyPlan = JSON.parse(storedPlan); } catch(e) {} }

    const dayNames = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
    const now = new Date();
    const dayOfWeek = now.getDay(); 
    const dateStr = now.toISOString().split('T')[0]; 

    // 初始化页面
    document.getElementById('day-title').innerText = dayNames[dayOfWeek] + "计划";
    document.getElementById('date-display').innerText = dateStr;
    renderList();
    initTimer(); 

    // === 计时器逻辑 (修复Bug版) ===
    let timerInterval = null;

    function initTimer() {
        // A. 加载平均时间
        const historyKey = `gym_history_${dayOfWeek}`;
        const history = JSON.parse(localStorage.getItem(historyKey) || "[]");
        
        const avgDisplay = document.getElementById('avg-time-display');
        
        // 【关键修复】: 使用 dayNames[dayOfWeek] 动态显示周几
        if (history.length === 0) {
            avgDisplay.innerText = `本${dayNames[dayOfWeek]}暂无记录，开始第一次训练吧！`;
        } else {
            const total = history.reduce((acc, cur) => acc + cur, 0);
            const avg = Math.round(total / history.length);
            avgDisplay.innerText = `本${dayNames[dayOfWeek]}最近3次平均时长: ${avg} 分钟`;
        }

        // B. 恢复计时状态
        const startTime = localStorage.getItem('timer_start_timestamp');
        if (startTime) {
            setTimerUIState(true);
            startTicker(parseInt(startTime));
        }
    }

    function toggleTimer() {
        const btn = document.getElementById('timer-action-btn');
        const startTime = localStorage.getItem('timer_start_timestamp');

        if (!startTime) {
            const nowTs = Date.now();
            localStorage.setItem('timer_start_timestamp', nowTs);
            setTimerUIState(true);
            startTicker(nowTs);
        } else {
            if(!confirm("确定结束本次训练并保存时长吗？")) return;
            
            const nowTs = Date.now();
            const durationMinutes = Math.round((nowTs - parseInt(startTime)) / 1000 / 60);
            
            saveHistory(durationMinutes);
            
            localStorage.removeItem('timer_start_timestamp');
            clearInterval(timerInterval);
            
            setTimerUIState(false);
            document.getElementById('timer-clock').innerText = "00:00:00";
            
            alert(`辛苦了！本次训练时长 ${durationMinutes} 分钟，已保存。`);
            initTimer(); // 刷新显示的平均时间
        }
    }

    function saveHistory(minutes) {
        if (minutes < 1) return;
        const historyKey = `gym_history_${dayOfWeek}`;
        let history = JSON.parse(localStorage.getItem(historyKey) || "[]");
        
        history.push(minutes);
        if (history.length > 3) history.shift();
        
        localStorage.setItem(historyKey, JSON.stringify(history));
    }

    function startTicker(startTimestamp) {
        if(timerInterval) clearInterval(timerInterval);
        updateClock(startTimestamp);
        timerInterval = setInterval(() => { updateClock(startTimestamp); }, 1000);
    }

    function updateClock(startTimestamp) {
        const diff = Date.now() - startTimestamp;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        const f = (n) => n.toString().padStart(2, '0');
        document.getElementById('timer-clock').innerText = `${f(hours)}:${f(minutes)}:${f(seconds)}`;
    }

    function setTimerUIState(isRunning) {
        const btn = document.getElementById('timer-action-btn');
        const clock = document.getElementById('timer-clock');
        if (isRunning) {
            btn.innerText = "结束训练";
            btn.className = "timer-btn btn-stop";
            clock.style.color = "#007aff";
        } else {
            btn.innerText = "开始计时";
            btn.className = "timer-btn btn-start";
            clock.style.color = "#1c1c1e";
        }
    }

    // === 列表渲染逻辑 ===
    function renderList() {
        const listContainer = document.getElementById('list-container');
        listContainer.innerHTML = '';
        
        const todayPlan = weeklyPlan[dayOfWeek] || [`休息日`];

        todayPlan.forEach((content, index) => {
            let title = content;
            let note = "";
            if (content.includes("<br>")) {
                const parts = content.split("<br>");
                title = parts[0];
                note = parts[1];
            }
            const pureActionName = title.split('|')[0].trim();

            const div = document.createElement('div');
            div.className = 'workout-item';
            
            const statusKey = `workout_${dateStr}_${index}`;
            const weightKey = `last_weight_${pureActionName}`;
            
            const isDone = localStorage.getItem(statusKey) === 'true';
            const lastWeight = localStorage.getItem(weightKey) || '';

            if (isDone) div.classList.add('completed');

            div.innerHTML = `
                <div class="item-header">
                    <div class="checkbox">${isDone ? '✔' : ''}</div>
                    <div class="text-content">
                        <span class="action-name">${title}</span>
                        ${note ? `<span class="action-note">${note}</span>` : ''}
                    </div>
                </div>
                <div class="weight-input-area">
                    <input type="number" class="weight-input" placeholder="${lastWeight ? lastWeight : '0'}" value="${lastWeight}">
                    <span class="weight-label">kg (上次: ${lastWeight ? lastWeight : '-'}kg)</span>
                </div>
            `;

            div.querySelector('.item-header').onclick = () => {
                const currentlyDone = div.classList.contains('completed');
                if (currentlyDone) {
                    div.classList.remove('completed');
                    div.querySelector('.checkbox').innerText = '';
                    localStorage.removeItem(statusKey);
                } else {
                    div.classList.add('completed');
                    div.querySelector('.checkbox').innerText = '✔';
                    localStorage.setItem(statusKey, 'true');
                }
                updateProgress();
            };

            div.querySelector('input').oninput = (e) => {
                localStorage.setItem(weightKey, e.target.value);
                div.querySelector('.weight-label').innerText = `kg (已存)`;
            };

            listContainer.appendChild(div);
        });
        updateProgress();
    }

    function updateProgress() {
        const total = document.querySelectorAll('.workout-item').length;
        const done = document.querySelectorAll('.workout-item.completed').length;
        if(total <= 1) { 
            document.getElementById('progress-text').innerText = "今日目标: 休息/恢复";
            return;
        }
        const percent = Math.round((done / total) * 100);
        document.getElementById('progress-text').innerText = `完成度: ${done}/${total} (${percent}%)`;
    }

    function openEditor() {
        const editor = document.getElementById('json-editor');
        editor.value = JSON.stringify(weeklyPlan, null, 4);
        document.getElementById('edit-modal').style.display = 'flex';
    }
    function savePlan() {
        try {
            weeklyPlan = JSON.parse(document.getElementById('json-editor').value);
            localStorage.setItem('my_custom_plan', JSON.stringify(weeklyPlan));
            renderList();
            closeEditor();
            alert("计划修改成功！");
        } catch (e) {
            alert("JSON 格式有误: " + e.message);
        }
    }
    function resetToDefault() {
        if(confirm("确定重置为默认计划？")) {
            weeklyPlan = defaultPlan;
            localStorage.removeItem('my_custom_plan');
            renderList();
            closeEditor();
        }
    }
    function closeEditor() {
        document.getElementById('edit-modal').style.display = 'none';
    }
    </script>
</body>
</html>
